=== RUN   TestClientCircuitBuilder_BuildCircuit_Success_MultiHop
    circuit_builder_test.go:290: NewMockHost: Generated ID QmSSVnBvXmZezGBYs4TtA26DSGMkCNLjVoe62x8brygPag, Listener 127.0.0.1:34109
    circuit_builder_test.go:292: NewMockHost: Registered host QmSSVnBvXmZezGBYs4TtA26DSGMkCNLjVoe62x8brygPag in store. Store size: 1
    circuit_builder_test.go:318: MockHost QmSSVnBvXmZezGBYs4TtA26DSGMkCNLjVoe62x8brygPag: Setting handler for '/wikileaks/onion-circuit-setup/1.0.0'
    circuit_builder_test.go:325: MockHost QmSSVnBvXmZezGBYs4TtA26DSGMkCNLjVoe62x8brygPag: Handlers map after setting '/wikileaks/onion-circuit-setup/1.0.0': [/wikileaks/onion-circuit-setup/1.0.0]
    circuit_builder_test.go:644: MockRelayNode QmSSVnBvXmZezGBYs4TtA26DSGMkCNLjVoe62x8brygPag: Registered handler for /wikileaks/onion-circuit-setup/1.0.0
    circuit_builder_test.go:318: MockHost QmSSVnBvXmZezGBYs4TtA26DSGMkCNLjVoe62x8brygPag: Setting handler for '/wikileaks/onion-circuit-teardown/1.0.0'
    circuit_builder_test.go:325: MockHost QmSSVnBvXmZezGBYs4TtA26DSGMkCNLjVoe62x8brygPag: Handlers map after setting '/wikileaks/onion-circuit-teardown/1.0.0': [/wikileaks/onion-circuit-setup/1.0.0 /wikileaks/onion-circuit-teardown/1.0.0]
    circuit_builder_test.go:647: MockRelayNode QmSSVnBvXmZezGBYs4TtA26DSGMkCNLjVoe62x8brygPag: Registered handler for /wikileaks/onion-circuit-teardown/1.0.0
    circuit_builder_test.go:649: MockRelayNode QmSSVnBvXmZezGBYs4TtA26DSGMkCNLjVoe62x8brygPag: Launching acceptLoop goroutine...
    circuit_builder_test.go:345: MockHost QmSSVnBvXmZezGBYs4TtA26DSGMkCNLjVoe62x8brygPag: Starting acceptLoop on 127.0.0.1:34109
    circuit_builder_test.go:290: NewMockHost: Generated ID QmXWcsqi6w67MYya6z5KTbaMBAfsrhqyyW2CQmJrMGs5or, Listener 127.0.0.1:38521
    circuit_builder_test.go:292: NewMockHost: Registered host QmXWcsqi6w67MYya6z5KTbaMBAfsrhqyyW2CQmJrMGs5or in store. Store size: 2
    circuit_builder_test.go:318: MockHost QmXWcsqi6w67MYya6z5KTbaMBAfsrhqyyW2CQmJrMGs5or: Setting handler for '/wikileaks/onion-circuit-setup/1.0.0'
    circuit_builder_test.go:325: MockHost QmXWcsqi6w67MYya6z5KTbaMBAfsrhqyyW2CQmJrMGs5or: Handlers map after setting '/wikileaks/onion-circuit-setup/1.0.0': [/wikileaks/onion-circuit-setup/1.0.0]
    circuit_builder_test.go:644: MockRelayNode QmXWcsqi6w67MYya6z5KTbaMBAfsrhqyyW2CQmJrMGs5or: Registered handler for /wikileaks/onion-circuit-setup/1.0.0
    circuit_builder_test.go:318: MockHost QmXWcsqi6w67MYya6z5KTbaMBAfsrhqyyW2CQmJrMGs5or: Setting handler for '/wikileaks/onion-circuit-teardown/1.0.0'
    circuit_builder_test.go:325: MockHost QmXWcsqi6w67MYya6z5KTbaMBAfsrhqyyW2CQmJrMGs5or: Handlers map after setting '/wikileaks/onion-circuit-teardown/1.0.0': [/wikileaks/onion-circuit-setup/1.0.0 /wikileaks/onion-circuit-teardown/1.0.0]
    circuit_builder_test.go:647: MockRelayNode QmXWcsqi6w67MYya6z5KTbaMBAfsrhqyyW2CQmJrMGs5or: Registered handler for /wikileaks/onion-circuit-teardown/1.0.0
    circuit_builder_test.go:649: MockRelayNode QmXWcsqi6w67MYya6z5KTbaMBAfsrhqyyW2CQmJrMGs5or: Launching acceptLoop goroutine...
    circuit_builder_test.go:345: MockHost QmXWcsqi6w67MYya6z5KTbaMBAfsrhqyyW2CQmJrMGs5or: Starting acceptLoop on 127.0.0.1:38521
    circuit_builder_test.go:290: NewMockHost: Generated ID QmRANtFK6Suxds9jzzCpyo64wjAHSk6rNoyfuBKTPATKbt, Listener 127.0.0.1:33181
    circuit_builder_test.go:292: NewMockHost: Registered host QmRANtFK6Suxds9jzzCpyo64wjAHSk6rNoyfuBKTPATKbt in store. Store size: 3
    circuit_builder_test.go:318: MockHost QmRANtFK6Suxds9jzzCpyo64wjAHSk6rNoyfuBKTPATKbt: Setting handler for '/wikileaks/onion-circuit-setup/1.0.0'
    circuit_builder_test.go:325: MockHost QmRANtFK6Suxds9jzzCpyo64wjAHSk6rNoyfuBKTPATKbt: Handlers map after setting '/wikileaks/onion-circuit-setup/1.0.0': [/wikileaks/onion-circuit-setup/1.0.0]
    circuit_builder_test.go:644: MockRelayNode QmRANtFK6Suxds9jzzCpyo64wjAHSk6rNoyfuBKTPATKbt: Registered handler for /wikileaks/onion-circuit-setup/1.0.0
    circuit_builder_test.go:318: MockHost QmRANtFK6Suxds9jzzCpyo64wjAHSk6rNoyfuBKTPATKbt: Setting handler for '/wikileaks/onion-circuit-teardown/1.0.0'
    circuit_builder_test.go:325: MockHost QmRANtFK6Suxds9jzzCpyo64wjAHSk6rNoyfuBKTPATKbt: Handlers map after setting '/wikileaks/onion-circuit-teardown/1.0.0': [/wikileaks/onion-circuit-setup/1.0.0 /wikileaks/onion-circuit-teardown/1.0.0]
    circuit_builder_test.go:647: MockRelayNode QmRANtFK6Suxds9jzzCpyo64wjAHSk6rNoyfuBKTPATKbt: Registered handler for /wikileaks/onion-circuit-teardown/1.0.0
    circuit_builder_test.go:649: MockRelayNode QmRANtFK6Suxds9jzzCpyo64wjAHSk6rNoyfuBKTPATKbt: Launching acceptLoop goroutine...
    circuit_builder_test.go:345: MockHost QmRANtFK6Suxds9jzzCpyo64wjAHSk6rNoyfuBKTPATKbt: Starting acceptLoop on 127.0.0.1:33181
    circuit_builder_test.go:290: NewMockHost: Generated ID QmNtbEg2ZqR3ji3oM8oiHsuzn8xDK9E5w3z2dgBv3BQtCD, Listener 127.0.0.1:37717
    circuit_builder_test.go:292: NewMockHost: Registered host QmNtbEg2ZqR3ji3oM8oiHsuzn8xDK9E5w3z2dgBv3BQtCD in store. Store size: 4
    circuit_builder_test.go:1158: Waiting for listeners to start...
    circuit_builder_test.go:1161: Listeners should be ready, now building circuit...
2025/04/21 18:05:31 [2025-04-21T18:05:31.974008308+06:00] Client: Building circuit 7d3a307c-ea2b-4388-88a2-e08b26363a70 with path: [QmSSVnBvXmZezGBYs4TtA26DSGMkCNLjVoe62x8brygPag QmXWcsqi6w67MYya6z5KTbaMBAfsrhqyyW2CQmJrMGs5or QmRANtFK6Suxds9jzzCpyo64wjAHSk6rNoyfuBKTPATKbt]
2025/04/21 18:05:31 [2025-04-21T18:05:31.974082509+06:00] Client: Opening setup stream to entry node QmSSVnBvXmZezGBYs4TtA26DSGMkCNLjVoe62x8brygPag for circuit 7d3a307c-ea2b-4388-88a2-e08b26363a70
    circuit_builder_test.go:478: MockHost QmNtbEg2ZqR3ji3oM8oiHsuzn8xDK9E5w3z2dgBv3BQtCD: Looked up peer QmSSVnBvXmZezGBYs4TtA26DSGMkCNLjVoe62x8brygPag in store, found host QmSSVnBvXmZezGBYs4TtA26DSGMkCNLjVoe62x8brygPag listening on 127.0.0.1:34109
    circuit_builder_test.go:479: MockHost QmNtbEg2ZqR3ji3oM8oiHsuzn8xDK9E5w3z2dgBv3BQtCD: Attempting net.Dial to resolved address 127.0.0.1:34109 for protocol /wikileaks/onion-circuit-setup/1.0.0
    circuit_builder_test.go:489: MockHost QmNtbEg2ZqR3ji3oM8oiHsuzn8xDK9E5w3z2dgBv3BQtCD: Dial successful to QmSSVnBvXmZezGBYs4TtA26DSGMkCNLjVoe62x8brygPag (127.0.0.1:34109). LocalAddr: 127.0.0.1:36088, RemoteAddr: 127.0.0.1:34109
    circuit_builder_test.go:502: MockHost QmNtbEg2ZqR3ji3oM8oiHsuzn8xDK9E5w3z2dgBv3BQtCD: Wrote protocol ID '/wikileaks/onion-circuit-setup/1.0.0' to QmSSVnBvXmZezGBYs4TtA26DSGMkCNLjVoe62x8brygPag
    circuit_builder_test.go:510: MockHost QmNtbEg2ZqR3ji3oM8oiHsuzn8xDK9E5w3z2dgBv3BQtCD (NewStream to QmSSVnBvXmZezGBYs4TtA26DSGMkCNLjVoe62x8brygPag): Performing client-side handshake for /wikileaks/onion-circuit-setup/1.0.0
    circuit_builder_test.go:360: MockHost QmSSVnBvXmZezGBYs4TtA26DSGMkCNLjVoe62x8brygPag: Accepted connection from 127.0.0.1:36088 on 127.0.0.1:34109
    circuit_builder_test.go:366: MockHost QmSSVnBvXmZezGBYs4TtA26DSGMkCNLjVoe62x8brygPag: Launching handleIncomingConn goroutine for 127.0.0.1:36088
    circuit_builder_test.go:373: MockHost QmSSVnBvXmZezGBYs4TtA26DSGMkCNLjVoe62x8brygPag: handleIncomingConn started for 127.0.0.1:36088
    circuit_builder_test.go:401: MockHost QmSSVnBvXmZezGBYs4TtA26DSGMkCNLjVoe62x8brygPag: Read protocol ID '/wikileaks/onion-circuit-setup/1.0.0' from 127.0.0.1:36088
    circuit_builder_test.go:410: MockHost QmSSVnBvXmZezGBYs4TtA26DSGMkCNLjVoe62x8brygPag: Looking for handler for protocol '/wikileaks/onion-circuit-setup/1.0.0' in handlers: [/wikileaks/onion-circuit-setup/1.0.0 /wikileaks/onion-circuit-teardown/1.0.0]
    circuit_builder_test.go:421: MockHost QmSSVnBvXmZezGBYs4TtA26DSGMkCNLjVoe62x8brygPag: Found handler for protocol '/wikileaks/onion-circuit-setup/1.0.0' from 127.0.0.1:36088
    circuit_builder_test.go:446: MockHost QmSSVnBvXmZezGBYs4TtA26DSGMkCNLjVoe62x8brygPag: Calling handler for protocol /wikileaks/onion-circuit-setup/1.0.0 from 127.0.0.1:36088
    circuit_builder_test.go:660: Relay QmSSVnBvXmZezGBYs4TtA26DSGMkCNLjVoe62x8brygPag: Entered handleCircuitSetupStream for stream QmSSVnBvXmZezGBYs4TtA26DSGMkCNLjVoe62x8brygPag--/wikileaks/onion-circuit-setup/1.0.0
    circuit_builder_test.go:669: Relay QmSSVnBvXmZezGBYs4TtA26DSGMkCNLjVoe62x8brygPag: handleCircuitSetupStream started for stream QmSSVnBvXmZezGBYs4TtA26DSGMkCNLjVoe62x8brygPag--/wikileaks/onion-circuit-setup/1.0.0 from 
    circuit_builder_test.go:674: Relay QmSSVnBvXmZezGBYs4TtA26DSGMkCNLjVoe62x8brygPag: Performing handshake on stream QmSSVnBvXmZezGBYs4TtA26DSGMkCNLjVoe62x8brygPag--/wikileaks/onion-circuit-setup/1.0.0...
    circuit_builder_test.go:688: Relay QmSSVnBvXmZezGBYs4TtA26DSGMkCNLjVoe62x8brygPag: Received handshake byte 1 (0x01) on stream QmSSVnBvXmZezGBYs4TtA26DSGMkCNLjVoe62x8brygPag--/wikileaks/onion-circuit-setup/1.0.0
MockStream <peer.ID Qm*rygPag>-><peer.ID > (Write 1 bytes): Attempting underlying write...
MockStream <peer.ID Qm*rygPag>-><peer.ID > (Write 1 bytes): Underlying write SUCCESS (1 bytes written).
MockStream <peer.ID Qm*rygPag>-><peer.ID > (Write 1 bytes): Writer is *bufio.Writer. Attempting flush...
MockStream <peer.ID Qm*rygPag>-><peer.ID > (Write 1 bytes): Flush successful.
    circuit_builder_test.go:697: Relay QmSSVnBvXmZezGBYs4TtA26DSGMkCNLjVoe62x8brygPag: Sent handshake byte 2 (0x02) on stream QmSSVnBvXmZezGBYs4TtA26DSGMkCNLjVoe62x8brygPag--/wikileaks/onion-circuit-setup/1.0.0. Handshake complete.
    circuit_builder_test.go:707: Relay QmSSVnBvXmZezGBYs4TtA26DSGMkCNLjVoe62x8brygPag: SetupStream QmSSVnBvXmZezGBYs4TtA26DSGMkCNLjVoe62x8brygPag--/wikileaks/onion-circuit-setup/1.0.0: Waiting for next message (before Decode)...
    circuit_builder_test.go:534: MockHost QmNtbEg2ZqR3ji3oM8oiHsuzn8xDK9E5w3z2dgBv3BQtCD (NewStream to QmSSVnBvXmZezGBYs4TtA26DSGMkCNLjVoe62x8brygPag): Handshake complete for /wikileaks/onion-circuit-setup/1.0.0
    circuit_builder_test.go:558: MockHost QmNtbEg2ZqR3ji3oM8oiHsuzn8xDK9E5w3z2dgBv3BQtCD: MockStream created for QmSSVnBvXmZezGBYs4TtA26DSGMkCNLjVoe62x8brygPag protocol /wikileaks/onion-circuit-setup/1.0.0
2025/04/21 18:05:31 [2025-04-21T18:05:31.975355808+06:00] Client: Setup stream opened: QmNtbEg2ZqR3ji3oM8oiHsuzn8xDK9E5w3z2dgBv3BQtCD-QmSSVnBvXmZezGBYs4TtA26DSGMkCNLjVoe62x8brygPag-/wikileaks/onion-circuit-setup/1.0.0
2025/04/21 18:05:31 [2025-04-21T18:05:31.975375596+06:00] Client: Performing handshake on stream QmNtbEg2ZqR3ji3oM8oiHsuzn8xDK9E5w3z2dgBv3BQtCD-QmSSVnBvXmZezGBYs4TtA26DSGMkCNLjVoe62x8brygPag-/wikileaks/onion-circuit-setup/1.0.0...
MockStream <peer.ID Qm*3BQtCD>-><peer.ID Qm*rygPag> (Write 1 bytes): Attempting underlying write...
MockStream <peer.ID Qm*3BQtCD>-><peer.ID Qm*rygPag> (Write 1 bytes): Underlying write SUCCESS (1 bytes written).
MockStream <peer.ID Qm*3BQtCD>-><peer.ID Qm*rygPag> (Write 1 bytes): Writer is *bufio.Writer. Attempting flush...
MockStream <peer.ID Qm*3BQtCD>-><peer.ID Qm*rygPag> (Write 1 bytes): Flush successful.
2025/04/21 18:05:32 [2025-04-21T18:05:32.025991769+06:00] Client: DIAGNOSTIC delay finished, proceeding to read handshake byte 2...
2025/04/21 18:05:37 [2025-04-21T18:05:37.02869382+06:00] Client: Resetting stream due to build error for circuit 7d3a307c-ea2b-4388-88a2-e08b26363a70
    circuit_builder_test.go:1174: 
        	Error Trace:	/home/jony/Project/decentralize-wikileaks/internal/onion/circuit_builder_test.go:1174
        	Error:      	Received unexpected error:
        	            	failed to read handshake byte 2 on stream QmNtbEg2ZqR3ji3oM8oiHsuzn8xDK9E5w3z2dgBv3BQtCD-QmSSVnBvXmZezGBYs4TtA26DSGMkCNLjVoe62x8brygPag-/wikileaks/onion-circuit-setup/1.0.0: read tcp 127.0.0.1:36088->127.0.0.1:34109: i/o timeout
        	Test:       	TestClientCircuitBuilder_BuildCircuit_Success_MultiHop
    circuit_builder_test.go:355: MockHost QmRANtFK6Suxds9jzzCpyo64wjAHSk6rNoyfuBKTPATKbt: Listener closed on 127.0.0.1:33181
    circuit_builder_test.go:715: Relay QmSSVnBvXmZezGBYs4TtA26DSGMkCNLjVoe62x8brygPag: SetupStream QmSSVnBvXmZezGBYs4TtA26DSGMkCNLjVoe62x8brygPag--/wikileaks/onion-circuit-setup/1.0.0: Decode error: unexpected EOF
    circuit_builder_test.go:355: MockHost QmSSVnBvXmZezGBYs4TtA26DSGMkCNLjVoe62x8brygPag: Listener closed on 127.0.0.1:34109
--- FAIL: TestClientCircuitBuilder_BuildCircuit_Success_MultiHop (8.89s)
FAIL
FAIL	github.com/jonybepary/decentralize-wikileaks/internal/onion	8.904s
FAIL
